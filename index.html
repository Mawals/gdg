<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance List from Google Sheets</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; color: #111; padding: 20px; direction: ltr; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .present { background: #16a34a; color: #fff; }
    .absent { background: #dc2626; color: #fff; }
  </style>
</head>
<body>

<h2>Student List from Google Sheets</h2>
<p>Source: Google Sheet published as CSV</p>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Phone</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="studentsBody">
    <tr><td colspan="4">Loading data...</td></tr>
  </tbody>
</table>

<p>
  Absent: <span id="absCount">0</span> — Present: <span id="presCount">0</span>
</p>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpYkLDu5kwHXqoqZ9WPonUBDVrrbF3eo4hSAiuQosDnrYcrepDiSvTs6o2gBFrAQ/pub?gid=109732210&single=true&output=csv';
const $ = selector => document.querySelector(selector);
const state = { students: [], attendance: {} };

function updateCounts() {
  let absent = 0, present = 0;
  state.students.forEach(s => state.attendance[s.id] === false ? absent++ : present++);
  $('#absCount').textContent = absent;
  $('#presCount').textContent = present;
}

function renderStudents() {
  const tbody = $('#studentsBody');
  tbody.innerHTML = '';

  state.students.forEach((student, index) => {
    if (!(student.id in state.attendance)) {
      state.attendance[student.id] = true;
    }
    const present = state.attendance[student.id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${student.name}</td>
      <td>${student.phone}</td>
    `;
    const tdStatus = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = present ? 'Present' : 'Absent';
    btn.className = present ? 'present' : 'absent';
    btn.onclick = () => {
      state.attendance[student.id] = !state.attendance[student.id];
      renderStudents();
    };
    tdStatus.appendChild(btn);
    tr.appendChild(tdStatus);
    tbody.appendChild(tr);
  });

  updateCounts();
}

async function loadCSVData() {
  try {
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error('Network error');
    const text = await res.text();
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

    const idIdx = headers.findIndex(h => /^(student_)?id|الرقم|رقم$/i.test(h));
    const nameIdx = headers.findIndex(h => /^(student_)?name|name|الاسم$/i.test(h));
    const phoneIdx = headers.findIndex(h => /^(mobile|phone|الهاتف|جوال)$/i.test(h));

    state.students = lines.slice(1).map((line, i) => {
      const cols = line.split(',');
      return {
        id: cols[idIdx] || `id-${i + 1}`,
        name: cols[nameIdx] || '—',
        phone: cols[phoneIdx]?.replace(/\s+/g, '') || '—'
      };
    });

    renderStudents();
  } catch (err) {
    $('#studentsBody').innerHTML = `<tr><td colspan="4">Failed to load data from Google Sheets</td></tr>`;
    console.error(err);
  }
}

window.addEventListener('DOMContentLoaded', loadCSVData);
</script>

</body>
</html>