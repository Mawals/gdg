<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f4f4; color: #111; padding: 20px; direction: rtl; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: right; }
    th { background: #eee; }
    button, select, input { padding: 6px 12px; margin-left: 10px; border: 1px solid #ccc; border-radius: 6px; }
    button { cursor: pointer; }
    .present { background: #16a34a; color: #fff; }
    .absent { background: #dc2626; color: #fff; }
    .controls { margin-bottom: 20px; }
  </style>
</head>
<body>

<h2>ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Google Sheets</h2>
<div class="controls">
  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: <input type="text" id="teacherName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"></label>
  <label>Ø§Ù„ØµÙ:
    <select id="gradeSelect">
      <option value="">Ø§Ø®ØªØ±</option>
      <option value="5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
      <option value="6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
      <option value="7">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹</option>
      <option value="8">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†</option>
      <option value="9">Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</option>
      <option value="10">Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±</option>
      <option value="11">Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</option>
      <option value="12">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±</option>
    </select>
  </label>
  <label>Ø§Ù„Ø´Ø¹Ø¨Ø©:
    <select id="sectionSelect">
      <option value="">Ø§Ø®ØªØ±</option>
      <option value="1">Ø§Ù„Ø´Ø¹Ø¨Ø© 1</option>
      <option value="2">Ø§Ù„Ø´Ø¹Ø¨Ø© 2</option>
      <option value="3">Ø§Ù„Ø´Ø¹Ø¨Ø© 3</option>
      <option value="4">Ø§Ù„Ø´Ø¹Ø¨Ø© 4</option>
      <option value="5">Ø§Ù„Ø´Ø¹Ø¨Ø© 5</option>
    </select>
  </label>
  <button onclick="loadCSVData()">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
  <button onclick="exportToGoogleSheet()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Google Sheets</button>
</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
    </tr>
  </thead>
  <tbody id="studentsBody">
    <tr><td colspan="4">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
  </tbody>
</table>

<p>
  Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†: <span id="absCount">0</span> â€” Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†: <span id="presCount">0</span>
</p>

<script>
const SHEET_URLS = [
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsicYUB3Mg9CjCulq7G9XjJaIv1oUrC2iYsOjCentY--D-o-skaLagx2S2-6a3AG5lJYOhBXtxNgpy/pub?gid=626465739&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSETRuCE4DjrPbJp7ANkud6uQgo6GAmwJZDgGxjqhA-ZYcTgj891GP6cuUwHdyKInBmXxefMiuXBlYX/pub?gid=1852000312&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAXVHqAU0XPZ2poN-EtryQdiODEAmByx-fz9Es_JM5DoidJ3FNCpu_IVSVdGcXrg/pub?gid=1965004906&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlddOYS7zhsG67Lb5x54TAb4fWL13U5RYv-Q9smwpxmSMpI4kk-ZzzWbLmPRERRw/pub?gid=1447060411&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7KbqnfE9B94juS9aNJ-5rDpxf124UUI08wyvPEDC8pkawSQrKUn0s6zrDdzlOZQ/pub?gid=909055846&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBcSFoTtPbKPoUEnHCwGCOY3IFqVFTtVzzvTNaQRthuZ7r1f66VFi2sTJNXLLv7w/pub?gid=182348005&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTq0aj1kCTEDLXpqvYPmlVr8FDM1XrFwOhi-9Nc3jaHpHvl_1pNZDJJ9EseDOyxgA/pub?gid=203618766&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTS9xXCBmTTkbpRm2jRuxW8gAFj7qWc5gBa12rW4aekIBdbUdq1J95hUtP5AE-eQg/pub?gid=1758546424&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTUUzUrIzzUwFWiLUfXdGvoUQDPFrkLiDFO-VY7VHmS0oSybff4xaW2IVyjr4fX-g/pub?gid=1883584808&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSxJnXKzAPG12TDLCzTzxSrluaemuM2RSj-evtvQ1aEEfA3SgoxZz1gjmaQ2EZlww/pub?gid=618519664&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRqR1nbKSty0XzrrQzgcFx2oeystbNA0aZpIGuY1kSlkal9xsdWhFNclKXba2JuBA/pub?gid=1097739551&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsHqf6Shu7ukRHeVj7DLqHLf-NIEdoSTvNZJqrP26B7041xZiVkP0PGpjxipadwA/pub?gid=1596997947&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0bONr2SDAdTZZxfKdxKxjpyZ2Ncs4aeenyI3nfEk6MSkoa9K-GGk6qSw_0SBDKA/pub?gid=1871382160&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_7lS3Zu8F_MZ-j4CjsMPIY8gVmGXcY_znaFcjp9jQdhl-6c205w6YRFSA9vJ-1g/pub?gid=1691264621&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdw3Mg0jKARpw9lwtPTH162mHbbHz97U1U1gbhIdXP56_-7ybF65N7tKsauJVWpg/pub?gid=462101614&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7dztFMM_plJfSpdicXLK7uyRIx8Xs5-IjOCPUkRfdrz-hKm1VYT1GPpC5v5yGMw/pub?gid=1919744920&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8Av8fdGXoHmJk5YxSS3Govwawo3nCbHoKOq2uy1jTA3nuhSfpKp2itzdteC2uBg/pub?gid=239546776&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQI30bspUg6tMMJXZCarjk90RfKu75kULbyyiO3Xf5LeSeveVP3QrbyOysFfFtncA/pub?gid=2003396707&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdgrZ3LpytSg8TsNpG5qCQD4PyiFLGn4qgol4IFxS-tDHWQeUwDx4bh9sTGTk9kQ/pub?gid=208968101&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRKnx9szqbU7DWcFqrsFiOi2EwFrGys-nv60eVjt5I5mHkB2y7vGlZDSji-_pg_Sg/pub?gid=1324465455&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ30PZRtyt4My_idjCARD-fziFUcT8PQM9tfgWLqGt55ck8JVRf9RufbS0OOa-qYw/pub?gid=374480414&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQMx_M0ZpKUl6BgdHbsFk9VCOdPileAql-F5PC5lBddw9WKZYW9DeoQG4jGNdnJQg/pub?gid=872744777&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNtPZzNRohia1QCy0x6XmEtWtD6XDbaG1Tnwy4_y5FPH-vS2v9s1l7lzMwQo24Dw/pub?gid=1326329366&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAOBVysdTzgj4ovChFdRIggayuSM8IjEY7dgjEgx2Sz7aA0cikZ4kj5YFw2RZPMQ/pub?gid=1947999420&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vRngvR6QjK6M4N9TlmVdz6rIdoS4upP7lsdwsnVyEt58vunWODUugjyeGyD-u7LbQ/pub?gid=1271116541&single=true&output=csv',
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKYmpN-VxxHY0qQjDIIc0jMPYs1p9SG5kZw2wtz7-irVEjKTNuqeljf1P_PULxWQ/pub?gid=1958896094&single=true
const EXPORT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw-WH146HgZOv84R9Pb5e9QtXqXKDzc9pNZ2pAJu0N2mxz9HikwwvTaDsufqnMl23lK/exec';
const $ = selector => document.querySelector(selector);
const state = { students: [], attendance: {} };

function updateCounts() {
  let absent = 0, present = 0;
  state.students.forEach(s => state.attendance[s.id] === false ? absent++ : present++);
  $('#absCount').textContent = absent;
  $('#presCount').textContent = present;
}

function renderStudents() {
  const tbody = $('#studentsBody');
  tbody.innerHTML = '';

  state.students.forEach((student, index) => {
    if (!(student.id in state.attendance)) {
      state.attendance[student.id] = true;
    }
    const present = state.attendance[student.id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${student.name}</td>
      <td>${student.phone}</td>
    `;
    const tdStatus = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = present ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨';
    btn.className = present ? 'present' : 'absent';
    btn.onclick = () => {
      state.attendance[student.id] = !state.attendance[student.id];
      renderStudents();
    };
    tdStatus.appendChild(btn);
    tr.appendChild(tdStatus);
    tbody.appendChild(tr);
  });

  updateCounts();
}

async function loadCSVData() {
  const grade = $('#gradeSelect').value.trim();
  const section = $('#sectionSelect').value.trim();
  if (!grade || !section) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø©');
    return;
  }

  try {
    let combinedText = '';
    for (const url of SHEET_URLS) {
      const res = await fetch(url);
      if (!res.ok) continue;
      const text = await res.text();
      combinedText += text.trim() + '\n';
    }
    const lines = combinedText.trim().split('\n');

    state.students = lines.slice(1).map((line, i) => {
      const cols = line.split(',');
      return {
        id: i + 1,
        phone: cols[0]?.trim() || '',
        name: cols[1]?.trim() || '',
        grade: cols[3]?.trim() || '',
        section: cols[4]?.trim() || ''
      };
    }).filter(s => s.grade === grade && s.section === section);

    renderStudents();
  } catch (err) {
    $('#studentsBody').innerHTML = `<tr><td colspan="4">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    console.error(err);
  }
}

function exportToGoogleSheet() {
  const absents = state.students.filter(s => state.attendance[s.id] === false);
  if (!absents.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù„ØªØµØ¯ÙŠØ±Ù‡.');
  const teacher = $('#teacherName').value.trim() || 'Ø§Ù„Ù…Ø¹Ù„Ù…';
  const grade = $('#gradeSelect').value;
  const section = $('#sectionSelect').value;
  const today = new Date().toLocaleDateString('ar-EG');

  const rows = absents.map((s, i) => ({
    serial: i + 1,
    phone: formatPhoneOM(s.phone),
    name: s.name,
    message: `ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ${s.name}ØŒ Ù†Ø¹Ù„Ù…ÙƒÙ… Ø¨ØºÙŠØ§Ø¨ Ø§Ø¨Ù†ÙƒÙ… Ø¹Ù† Ø§Ù„ØµÙ ${grade}/${section} Ø¨ØªØ§Ø±ÙŠØ® ${today}. â€” ${teacher}`
  }));

  fetch(EXPORT_WEBAPP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(rows)
  }).then(() => {
    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Google Ø¨Ù†Ø¬Ø§Ø­');
  }).catch(err => {
    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙŠØª');
    console.error(err);
  });
}

function formatPhoneOM(raw) {
  const cleaned = raw.replace(/[^\d]/g, '');
  if (cleaned.startsWith('968')) return cleaned;
  if (cleaned.startsWith('0')) return '968' + cleaned.slice(1);
  if (cleaned.length === 8) return '968' + cleaned;
  return '';
}
</script>

</body>
</html>
